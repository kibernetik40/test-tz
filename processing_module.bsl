// Модуль внешней обработки: Удалить не ключевые платформы
// Скопируйте этот текст в модуль внешней обработки (.epf -> Модуль обработки) или в модуль формы.

Процедура ВыполнитьУдаление(Команда) Экспорт
    Попытка
        // Резервная копия и безопасность на вашей стороне — сделайте дамп базы перед выполнением.
        ЗначКонст = Константы.ПлатформыРезерв.Получить();
        СписокСсылок = СобратьСсылкиИзХранилища(ЗначКонст);

        Если СписокСсылок = Неопределено Или СписокСсылок.Количество() = 0 Тогда
            Сообщить("В константе 'ПлатформыРезерв' нет платформ для проверки.");
            Возврат;
        КонецЕсли;

        // Получим информацию пакетно: построим массив идентификаторов ссылок
        МассивСсылок = Новый Массив;
        Для Каждого Сс Из СписокСсылок Цикл
            Если ТипЗнч(Сс) = Тип("СправочникСсылка") Тогда
                МассивСсылок.Добавить(Сс);
            Иначе
                // Если элемент уже строка (GUID) — пробуем преобразовать (см. функцию)
                Если ТипЗнч(Сс) = Тип("Строка") Тогда
                    СпрСсылка = ПреобразоватьGUIDВСсылку(Сс);
                    Если ЗначениеЗаполнено(СпрСсылка) Тогда
                        МассивСсылок.Добавить(СпрСсылка);
                    КонецЕсли;
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;

        // Если число ссылок велико — пакетный запрос. Но для простоты реализуем построчную проверку.
        МассивОставшихся = Новый Массив;
        МассивУдалённых = Новый Массив;
        Для Каждого Ссылка Из МассивСсылок Цикл
            Если ЗначениеЗаполнено(Ссылка) Тогда
                // Получим значения реквизитов без создания полного объекта (если конфигурация позволяет — через запрос)
                Элем = Справочники.Платформы.Получить(Ссылка);
                Если ЗначениеЗаполнено(Элем) Тогда
                    Если Элем.Ключевая = Истина Тогда
                        МассивОставшихся.Добавить(Ссылка);
                    Иначе
                        МассивУдалённых.Добавить(Ссылка);
                    КонецЕсли;
                Иначе
                    // Если не получилось получить элемент — пропустить
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;

        // Записать обратно в константу только оставшиеся (в том же формате, в котором хранилище поддерживает — 
        // здесь сохраняем как Массив ссылок).
        НовоеЗначение = МассивОставшихся;
        Константы.ПлатформыРезерв.Установить(НовоеЗначение);
        Константы.ПлатформыРезерв.Записать();

        // Подготовим удобный вывод
        Сообщение = СформироватьСообщениеУдалённых(МассивУдалённых);
        Сообщить(Сообщение);

        // При желании — вывести оставшиеся платформы в форме. Если у вас есть форма, можно вызвать процедуру ПостроитьТаблицуОставшихся(МассивОставшихся)
    Исключение
        Сообщить("Ошибка при выполнении обработки: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

// Функция: собрать ссылки из разных форматов, которые могли быть записаны в константу
Функция СобратьСсылкиИзХранилища(ЗначКонст)
    Результат = Новый Массив;
    Если ЗначКонст = Неопределено Тогда
        Возврат Результат;
    КонецЕсли;

    ТипЗ = ТипЗнч(ЗначКонст);
    // Строка: ожидаем GUID-строки, разделённые ';'
    Если ТипЗ = Тип("Строка") Тогда
        Если ПустаяСтрока(СокрЛП(ЗначКонст)) Тогда
            Возврат Результат;
        КонецЕсли;
        Список = СтрРазделить(ЗначКонст, ";");
        Для Каждого s Из Список Цикл
            sTrim = СокрЛП(s);
            Если Не ПустаяСтрока(sTrim) Тогда
                Результат.Добавить(sTrim);
            КонецЕсли;
        КонецЦикла;
        Возврат Результат;
    КонецЕсли;

    // Массив ссылок (тип Массив)
    Если ТипЗ = Тип("Массив") Тогда
        Для Каждого Эл Из ЗначКонст Цикл
            Результат.Добавить(Эл);
        КонецЦикла;
        Возврат Результат;
    КонецЕсли;

    // ТаблицаЗначений: ищем колонку с ссылкой (популярное имя "Платформа" или "ПлатформаСсылка")
    Если ТипЗ = Тип("ТаблицаЗначений") Тогда
        Для Каждого Строка Из ЗначКонст Цикл
            Если Строка.Свойство("Платформа") Тогда
                Результат.Добавить(Строка.Платформа);
            ИначеЕсли Строка.Свойство("ПлатформаСсылка") Тогда
                Результат.Добавить(Строка.ПлатформаСсылка);
            КонецЕсли;
        КонецЦикла;
        Возврат Результат;
    КонецЕсли;

    Возврат Результат;
КонецФункции

// Преобразование GUID-строки в ссылку на справочник — ЗАМЕНИТЕ под вашу конфигурацию.
// В типовых конфигурациях GUID может храниться в реквизите 'ВнешнийИдентификатор' или 'GUID'.
// Здесь реализована заглушка: пробуем найти элемент по внешнему идентификатору, иначе возвращаем Неопределено.
Функция ПреобразоватьGUIDВСсылку(СтрокаGUID)
    Если ПустаяСтрока(СтрокаGUID) Тогда
        Возврат Неопределено;
    КонецЕсли;
    // Пример запроса — адаптируйте имя реквизита под вашу конфигурацию:
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |Справочник.Платформы.Ссылка КАК Ссылка
        |ИЗ
        |Справочник.Платформы КАК Справочник.Платформы
        |ГДЕ
        |Справочник.Платформы.ВнешнийИдентификатор = &GUID";
    Запрос.УстановитьПараметр("GUID", СтрокаGUID);
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    Если Выборка.Следующий() Тогда
        Возврат Выборка.Ссылка;
    Иначе
        // не найдено
        Возврат Неопределено;
    КонецЕсли;
КонецФункции

// Сформировать сообщение об удалённых элементах
Функция СформироватьСообщениеУдалённых(МассивУдалённых)
    Если МассивУдалённых = Неопределено Или МассивУдалённых.Количество() = 0 Тогда
        Возврат "Не удалено ни одной платформы (все платформы помечены как ключевые).";
    КонецЕсли;
    СписокСтруктур = Новый Массив;
    Для Каждого Сс Из МассивУдалённых Цикл
        Элем = Справочники.Платформы.Получить(Сс);
        Если ЗначениеЗаполнено(Элем) Тогда
            Стр = Новый Структура;
            Стр.Вставить("Наименование", Элем.Наименование);
            Стр.Вставить("ЧисловойКод", ?(ТипЗнч(Элем.ЧисловойКод)=Тип("Число"), Элем.ЧисловойКод, 0));
            Стр.Вставить("Ссылка", Сс);
            СписокСтруктур.Добавить(Стр);
        КонецЕсли;
    КонецЦикла;
    // Сортируем по возрастанию ЧисловойКод
    СписокСтруктур.СортироватьПо(Новый ОписаниеСравнения("ЧисловойКод"));
    СписокИмен = "";
    Для Каждого s Из СписокСтруктур Цикл
        Если СписокИмен <> "" Тогда СписокИмен = СписокИмен + ", ";
        СписокИмен = СписокИмен + s.Наименование + "-" + Формат(s.ЧисловойКод, "ЧГ=0");
    КонецЦикла;
    Возврат "Удалено платформ: " + Строка(МассивУдалённых.Количество()) + " (" + СписокИмен + ").";
КонецФункции

